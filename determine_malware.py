# The purpose of this script is to determine if a give a sample is malicious according to the following
# criteria. If the sample has 2 or more detection from VirusTotal, it is considered malicious, otherwise
# if it has one or less detections, it is considered non-malicious.

import os
import json
import pandas as pd


# Define the path to the aggregated_data folder
aggregated_data_dir = 'aggregated_data'

# Iterate through JSON files in the aggregated_data folder
for filename in os.listdir(aggregated_data_dir):
    if filename.endswith('.json'):
        ## file path of data
        file_path = os.path.join(aggregated_data_dir, filename)
        # Read the JSON data from the file
        with open(file_path, 'r') as json_file:
            data = json.load(json_file)

        csv_filename = "sample_list.csv"
        # Load the CSV file using pandas
        df = pd.read_csv(csv_filename)

        # Find the corresponding row based on the given hash value
        matching_row = df[df['Hash'] == data['live']['application']['hash']]

        if matching_row.empty:
            continue

        detections = matching_row['detections'].iloc[0]
        data['VirusTotal'] = {}
        data['VirusTotal']['detections'] = int(detections)
        if detections >= 2:
            data['VirusTotal']['malicious'] = 1
        else:
            data['VirusTotal']['malicious'] = 0

        # Write the updated JSON data back to the file
        with open(file_path, 'w') as json_file:
            json.dump(data, json_file, indent=4)

        print(f'Updated {filename}.')
        

print('Processing complete.')