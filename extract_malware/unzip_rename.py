import pandas as pd
import os, zipfile

### Variables
zip_path = "samples" # path that contains zipped files
extraction_path = "extracted" # path to put extracted and renamed files
csv_path = "client_data.csv" # path to the CSV file with hash and filenams
zip_pass = "infected" # password for zip file
skip_extraction = True # skip extracting files found in zip_path
skip_rename = False # skip renaming files to their filename



def main():
    white_list = []
    ## test if extraction and zip paths exists
    if not os.path.exists(extraction_path):
        os.mkdir(extraction_path)
    if not os.path.exists(zip_path):
        return print(f"Zip path: {zip_path} not found!")
    ## import the csv key to match hashes with filenames
    key = pd.read_csv(csv_path)
    ## extract files in the zip_path directory
    if skip_extraction is not True:
        for zip_file in os.listdir(zip_path):
            try:
                with zipfile.ZipFile(f"{zip_path}/{zip_file}") as file:
                    file.extractall(extraction_path, pwd=bytes(zip_pass, 'utf-8'))
            except:
                with zipfile.ZipFile(f"{zip_path}/{zip_file}") as file:
                    file.extractall(extraction_path)             
    ## rename files in the extraction_path directory
    if skip_rename is not True:
        for file in os.listdir(extraction_path):
            file_info = key.loc[key['Hash'] == file]
            if len(file_info) <= 0:
                print(f"{file} not found in key!")
                continue
            else:
                file_info = file_info.iloc[0]
                file_name = file_info.Filename
                try:
                    os.rename(f"{extraction_path}/{file}", f"{extraction_path}/{file_name}")
                    white_list.append(file_name)
                except:
                    pass
        for file in os.listdir(extraction_path):
            if file not in white_list:
                os.remove(f"{extraction_path}/{file}")
main()